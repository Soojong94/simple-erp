# 🐛 미수금 자동 증가 문제 해결 컨텍스트

## 📋 현재 상황

### 문제
- **거래 생성 시 미수금이 자동으로 증가하지 않음**
- 거래처 "abc"에 매출 거래 133,000원 생성
- 미수금이 100,000원으로 유지됨 (233,000원으로 증가해야 함)

### 확인된 사항
1. ✅ CustomerModal UI는 정상 작동 (수동 수정 가능)
2. ✅ 오타 수정 완료 ("잘못 입력 시")
3. ❌ 거래 생성 시 미수금 자동 증가 로직이 실행되지 않음
4. ❌ 콘솔에 디버깅 로그가 전혀 나타나지 않음

### 콘솔 로그 상태
```
[vite] hot updated: ... (여러 파일들)
```
- 예상했던 디버깅 로그가 없음:
  - `🔍 미수금 체크: ...`
  - `💰 미수금 증가 조건 충족 ...`
  - `✅ 미수금 자동 증가: ...`

---

## 🔍 원인 분석

### 가능한 원인들

#### 1. **Vite HMR(Hot Module Replacement) 캐싱 문제**
- 파일을 수정했지만 브라우저가 캐시된 버전을 사용 중
- 해결: 브라우저 강력 새로고침 필요

#### 2. **타입스크립트 빌드 문제**
- 수정한 코드가 실제로 실행 파일에 반영되지 않음
- 해결: 개발 서버 재시작 필요

#### 3. **조건문 실행 실패**
```typescript
if (transactionData.transaction_type === 'sales' && customer) {
  // 이 부분이 실행 안 됨
}
```
- `transactionData.transaction_type`이 `'sales'`가 아닐 수 있음
- `customer` 객체가 `null` 또는 `undefined`일 수 있음

#### 4. **localStorage 키 충돌**
- 회사별 키(`simple-erp-c1-customers`)가 제대로 생성되지 않음
- `getStorageKeys()` 함수 문제

---

## 🔧 해결 단계

### Step 1: 개발 서버 재시작 (최우선)
```bash
# 터미널에서
Ctrl + C  # 서버 종료
npm run dev  # 서버 재시작
```

### Step 2: 브라우저 강력 새로고침
```
Ctrl + Shift + R  (Windows/Linux)
Cmd + Shift + R   (Mac)
```

### Step 3: 콘솔 로그 확인
거래 생성 후 개발자 도구(F12) → Console 탭에서 다음 로그 확인:
```
✅ 거래 #X 생성 완료 - 재고 자동 처리됨
🔍 미수금 체크: transaction_type=sales, customer= {객체}
💰 미수금 증가 조건 충족 - 실행 중...
  거래처 인덱스: 0
  기존 미수금: 100000원
  거래 금액: 133000원
  새 미수금: 233000원
✅ 미수금 자동 증가: abc +133000원 (100000원 → 233000원)
  localStorage 저장 완료: simple-erp-c1-customers
```

### Step 4: localStorage 직접 확인
개발자 도구(F12) → Application → Local Storage → http://localhost:5173
- Key: `simple-erp-c1-customers` (회사 ID에 따라 다름)
- 거래처 "abc"의 `outstanding_balance` 값 확인

---

## 📝 수정된 파일들

### 1. `src/types/index.ts`
```typescript
export interface Customer {
  // ...
  outstanding_balance?: number  // 🆕 미수금
}

export type InvoiceTemplate = 'default' | 'striped'  // 🆕
export interface InvoiceGenerateOptions { ... }  // 🆕
```

### 2. `src/components/modals/CustomerModal.tsx`
- 미수금 관리 UI 추가
- 완납 처리, 수금 입력 버튼
- 오타 수정 ("잘못 입력 시")

### 3. `src/lib/tauri.ts`
```typescript
// transactionAPI.create 함수에 추가
if (transactionData.transaction_type === 'sales' && customer) {
  // 미수금 자동 증가 로직
  const currentBalance = customers[customerIndex].outstanding_balance || 0
  customers[customerIndex].outstanding_balance = currentBalance + newTransaction.total_amount
  setToStorage(STORAGE_KEYS.CUSTOMERS, customers)
}
```

---

## 🎯 기대 동작

### 정상 작동 시:
1. 매출 거래 생성
2. 콘솔에 로그 출력:
   ```
   🔍 미수금 체크: transaction_type=sales, customer= {...}
   💰 미수금 증가 조건 충족 - 실행 중...
   ✅ 미수금 자동 증가: abc +133000원
   ```
3. 거래처 정보에서 미수금 확인 → 233,000원

### 비정상 작동 시 (현재):
1. 매출 거래 생성
2. 콘솔에 아무 로그 없음
3. 거래처 정보에서 미수금 확인 → 100,000원 (변화 없음)

---

## 💡 임시 해결책

개발 서버 재시작 후에도 문제가 계속되면:

### 방법 1: 수동 미수금 업데이트
1. 거래처 관리 → "abc" 수정
2. 미수금을 233,000원으로 수정
3. 저장

### 방법 2: localStorage 직접 수정
```javascript
// 개발자 도구 Console에서 실행
const customers = JSON.parse(localStorage.getItem('simple-erp-c1-customers'))
const abc = customers.find(c => c.name === 'abc')
abc.outstanding_balance = 233000
localStorage.setItem('simple-erp-c1-customers', JSON.stringify(customers))
location.reload()
```

---

## 🔄 다음 액션

1. **즉시 실행**: 개발 서버 재시작 + 브라우저 강력 새로고침
2. **테스트**: 새 거래 생성 후 콘솔 로그 확인
3. **보고**: 콘솔에 나타나는 모든 로그 공유
4. **추가 디버깅**: 로그가 여전히 안 나오면 코드 위치 재확인 필요

---

## 📌 중요 체크포인트

- [ ] 개발 서버 재시작 완료
- [ ] 브라우저 강력 새로고침 완료
- [ ] 새 거래 생성 시도
- [ ] 콘솔 로그 확인
- [ ] localStorage 값 확인
- [ ] 미수금이 자동 증가하는지 확인

---

## 🚨 긴급 노트

**만약 계속 안 된다면**:
- `transactionData.transaction_type`의 실제 값이 무엇인지 확인 필요
- TransactionModal에서 전달하는 데이터 구조 확인 필요
- 가능성: `transaction_type`이 `'매출'` (한글) 또는 다른 값일 수 있음
